# Project Rules - Proxy Forward Windows

## Build Configuration

### Binary Output
- **Development Build**: `cmd\proxy-fwd\proxy-fwd.exe`
- **Release Build**: `release\bin\proxy-fwd-v{VERSION}.exe`
- **Portable Package**: `release\proxy-forwarder-portable-v{VERSION}.zip`
- **Installer Package**: `release\proxy-forwarder-installer-v{VERSION}.zip`

### Build Commands

**Development Build:**
```powershell
# Quick build for testing
go build -o .\cmd\proxy-fwd\proxy-fwd.exe .\cmd\proxy-fwd
```

**Production Build:**
```powershell
# Optimized build with stripped symbols
go build -trimpath -ldflags "-s -w -X main.version={VERSION} -X main.buildTime={BUILD_TIME}" -o .\release\bin\proxy-fwd-v{VERSION}.exe .\cmd\proxy-fwd
```

**Release Build with Version:**
```powershell
# Example: Build version 1.2.0
$VERSION = "1.2.0"
$BUILD_TIME = Get-Date -Format "yyyy-MM-dd_HH:mm:ss"
go build -trimpath -ldflags "-s -w -X main.version=$VERSION -X main.buildTime=$BUILD_TIME" -o ".\release\bin\proxy-fwd-v$VERSION.exe" .\cmd\proxy-fwd
```

### Build Flags Explained
- `-trimpath`: Remove file system paths from compiled binary for reproducible builds
- `-ldflags "-s -w"`: Strip debug info and symbol table (reduces binary size ~30%)
- `-X main.version={VERSION}`: Inject version string into binary
- `-X main.buildTime={BUILD_TIME}`: Inject build timestamp into binary

## Versioning

### Version Format
- **Semantic Versioning**: `MAJOR.MINOR.PATCH`
- **Example**: `1.2.3`
  - `MAJOR`: Breaking changes or major feature releases
  - `MINOR`: New features, backward compatible
  - `PATCH`: Bug fixes, backward compatible

### Version History
- `1.0.0` - Initial release with basic proxy forwarding
- `1.1.0` - Added CloudMini integration and proxy pool
- `1.2.0` - Removed residential-only filter, sync all proxy types

### Current Version
- **Version**: `1.2.0`
- **Release Date**: 2025-10-13
- **Codename**: Multi-Type Sync

### Git Tagging
```powershell
# Tag format: v{VERSION}
git tag -a v1.2.0 -m "Release v1.2.0: Sync all proxy types from CloudMini"
git push origin v1.2.0
```

### Version Injection (Future Enhancement)
Add to `main.go`:
```go
var (
    version   = "dev"
    buildTime = "unknown"
)

func init() {
    log.Printf("Proxy Forward v%s (built: %s)", version, buildTime)
}
```

## Release Process

### 1. Pre-Release Checklist
- [ ] All tests passing
- [ ] Update CHANGELOG.md with new version
- [ ] Update version in README.md
- [ ] Update version in build scripts
- [ ] Code review completed
- [ ] No sensitive data in code

### 2. Build Release Artifacts
```powershell
# Set version
$VERSION = "1.2.0"
$BUILD_TIME = Get-Date -Format "yyyy-MM-dd_HH:mm:ss"

# Clean release directory
Remove-Item -Recurse -Force .\release\bin -ErrorAction SilentlyContinue
New-Item -ItemType Directory -Force .\release\bin

# Build binary
go build -trimpath -ldflags "-s -w -X main.version=$VERSION -X main.buildTime=$BUILD_TIME" -o ".\release\bin\proxy-fwd-v$VERSION.exe" .\cmd\proxy-fwd

# Create portable package
Compress-Archive -Path .\release\bin\proxy-fwd-v$VERSION.exe,.\README.md,.\scripts -DestinationPath ".\release\proxy-forwarder-portable-v$VERSION.zip" -Force

# Copy to release folder
Copy-Item ".\release\bin\proxy-fwd-v$VERSION.exe" ".\release\proxy-fwd.exe" -Force
```

### 3. Test Release Build
```powershell
cd .\release\bin
.\proxy-fwd-v1.2.0.exe
# Verify UI opens at http://127.0.0.1:17890
# Test basic functionality
```

### 4. Create GitHub Release
```powershell
# Create git tag
git tag -a v$VERSION -m "Release v$VERSION: [Description]"
git push origin v$VERSION

# Upload to GitHub Releases:
# - proxy-fwd-v{VERSION}.exe (standalone binary)
# - proxy-forwarder-portable-v{VERSION}.zip (with docs)
# - Include release notes from CHANGELOG.md
```

## Project Structure

```
proxy-fwd-windows/
├── cmd/
│   └── proxy-fwd/              # Main application source
│       ├── main.go             # Entry point + version info
│       ├── types.go            # Data structures
│       ├── manager.go          # Proxy lifecycle management
│       ├── proxy.go            # Proxy forwarding logic
│       ├── handlers.go         # API handlers
│       ├── ui.go              # Embedded web UI
│       ├── cloudmini.go        # CloudMini helpers
│       ├── cloudmini_handlers.go # CloudMini API integration
│       └── proxy-fwd.exe       # Development build (gitignored)
├── release/
│   ├── bin/                    # Release binaries
│   │   └── proxy-fwd-v*.exe
│   ├── DISTRIBUTION.md         # Distribution notes
│   └── *.zip                   # Release packages
├── scripts/
│   └── firewall_rules.ps1      # Firewall configuration
├── build.ps1                   # Automated build script
├── go.mod                      # Go module definition
├── go.sum                      # Dependency checksums
├── .gitignore                  # Git ignore patterns
├── .project-rules.md           # This file
├── WARP.md                     # Warp AI guidance
├── README.md                   # User documentation
├── BUILD.md                    # Build instructions
├── QUICKSTART.md               # Quick start guide
└── proxies.yaml                # Runtime state (gitignored)
```

## Build Artifacts (Gitignored)

```gitignore
# Development builds
cmd/proxy-fwd/proxy-fwd.exe
cmd/proxy-fwd/*.exe

# Release builds
release/bin/
release/*.zip

# Runtime data
proxies.yaml
*.log

# Go build cache
*.test
*.exe (except in release/)
```

## Naming Conventions

### Files
- **Source files**: `lowercase_with_underscores.go`
- **Config files**: `UPPERCASE.md` (docs), `lowercase.yaml` (configs)
- **Scripts**: `lowercase_with_underscores.ps1`

### Binaries
- **Development**: `proxy-fwd.exe`
- **Release**: `proxy-fwd-v{VERSION}.exe`
- **Service name**: `ProxyFwd`

### Packages
- **Portable**: `proxy-forwarder-portable-v{VERSION}.zip`
- **Installer**: `proxy-forwarder-installer-v{VERSION}.zip`

## Environment Variables

### Development
```powershell
$env:UI_ADDR = "127.0.0.1:17890"    # UI server address (must be localhost)
$env:ADMIN_TOKEN = "dev-token"       # Optional admin token
$env:INITIAL_API = ""                # Optional initial sync URL
$env:INITIAL_PROXIES = ""            # Optional initial proxy list
```

### Production
```powershell
$env:UI_ADDR = "127.0.0.1:17890"
$env:ADMIN_TOKEN = "STRONG_RANDOM_TOKEN_HERE"
```

## Code Standards

### Go Style
- Follow standard Go formatting (`gofmt`)
- Use meaningful variable names
- Add comments for exported functions
- Keep functions focused and small (< 100 lines)

### Error Handling
- Always check errors
- Log errors with context
- Return errors, don't panic (except in init/main)
- Use `fmt.Errorf` with `%w` for error wrapping

### Concurrency
- Protect shared state with `sync.RWMutex`
- Use contexts for cancellation
- Clean up goroutines on shutdown

### Security
- Force localhost-only binding for UI
- Validate all external inputs
- Sanitize IDs and file paths
- Use atomic file operations for state

## Testing

### Manual Testing Checklist
- [ ] Binary runs and shows UI
- [ ] Can add proxy manually
- [ ] Can start/stop proxy
- [ ] Health check triggers auto-shutdown
- [ ] State persists across restarts
- [ ] CloudMini sync works
- [ ] API endpoints respond correctly
- [ ] Admin token protection works

### Test Proxy
```powershell
# Test through local proxy
curl -x http://127.0.0.1:10001 http://httpbin.org/ip

# Check proxy status
curl http://127.0.0.1:17890/api/list
```

## Deployment

### Standalone Executable
1. Copy `proxy-fwd-v{VERSION}.exe` to target machine
2. Run directly or set environment variables
3. Access UI at http://127.0.0.1:17890

### Windows Service
```powershell
# Install
$EXE = "C:\ProxyFwd\proxy-fwd.exe"
New-Item -Force -ItemType Directory C:\ProxyFwd
Copy-Item .\proxy-fwd-v{VERSION}.exe $EXE
sc.exe create ProxyFwd binPath= "`"$EXE`"" start= auto DisplayName= "Proxy Forward"
sc.exe start ProxyFwd

# Uninstall
sc.exe stop ProxyFwd
sc.exe delete ProxyFwd
```

### System Requirements
- **OS**: Windows 10 or later (64-bit)
- **RAM**: 50-100 MB
- **Disk**: 10 MB for binary + minimal for state
- **Network**: Outbound HTTPS for upstream proxies

## Changelog Format

```markdown
# Changelog

## [1.2.0] - 2025-10-13
### Changed
- Removed residential-only filter in CloudMini sync
- Now syncs all proxy types (residential, ISP, static, datacenter)

### Fixed
- Improved logging for CloudMini sync operations

## [1.1.0] - 2025-10-12
### Added
- CloudMini API integration
- Proxy pool management
- Bulk operations

## [1.0.0] - 2025-10-01
### Added
- Initial release
- Basic proxy forwarding
- Web UI
- Health monitoring
```

## Git Workflow

### Branch Strategy
- `main` - Production-ready code
- `develop` - Development branch
- `feature/*` - Feature branches
- `hotfix/*` - Urgent fixes

### Commit Message Format
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types**: feat, fix, docs, style, refactor, test, chore

**Example**:
```
feat(cloudmini): remove residential-only filter

- Sync all proxy types from CloudMini API
- Remove hostname pattern filtering
- Update logs to reflect all-proxy sync

Closes #42
```

## Maintenance

### Dependency Updates
```powershell
# Check for updates
go list -u -m all

# Update specific dependency
go get -u github.com/elazarl/goproxy

# Update all dependencies
go get -u ./...
go mod tidy
```

### Security Checks
- Review dependencies monthly
- Check for CVEs in dependencies
- Keep Go toolchain updated
- Audit third-party proxy sources

---

**Last Updated**: 2025-10-13
**Maintainer**: Development Team
**Version**: 1.2.0
